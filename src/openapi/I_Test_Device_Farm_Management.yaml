
openapi: 3.1.0
info:
  title: Test Farm FDV Device Management API
  description: |
    ## API to manage FDV devices from the test farm
    ### Proxied Device Endpoints
    Functional APIs of devices are exposed via the gateway under paths like:
    `/epa-fdv-test-farm/devices/{deviceId}/{functional-endpoint-path}`
    where `{functional-endpoint-path}` is the path of the functional API endpoint documented in I_Test_Driver_FdV.yaml you want to access.
    The `{deviceId}` can be obtained by calling the `/devices` endpoint.
  version: 4.1.0
  contact:
    name: gematik GmbH
    email: software-development@gematik.de
    url: "https://www.gematik.de"
  license:
    name: Apache 2.0
    url: "https://www.apache.org/licenses/LICENSE-2.0"
servers:
      - url: '{protocol}://{host}:{port}/{application}'
        variables:
          protocol:
            enum:
              - http
              - https
            default: https
          host:
            default: 'localhost'
          port:
            default: '443'
          application:
            default: 'epa-fdv-test-farm'


tags:
  - name: Device Management
    description: Endpoint to manage FDV devices

paths:
  /devices:
    get:
      description: Returns devices matching the given query parameters.
      tags:
        - Device Management
      operationId: getDevices
      parameters:
        - in: query
          name: insurant_id
          description: The insurantId the device is related to.
          schema:
            $ref: "#/components/schemas/KvnrType"
        - in: query
          name: device_os
          description: The OS of the devices to retrieve
          schema:
            type: string
            enum: [ android, ios, windows, linux, macos ]
            example: android
        - in: query
          name: device_status
          description: "Status of the device"
          schema:
            type: string
            enum: [ claimed, free ]
            example: claimed
      responses:
        "200":
          description: List of devices matching the given parameters
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Device"
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /devices/{deviceId}/claim:
    parameters:
      - $ref: "#/components/parameters/deviceId"
    put:
      tags:
        - Device Management
      description: "Claims a device for exclusive use."
      operationId: claimDevice

      responses:
        '200':
          description: "Device successfully claimed"
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: "#/components/responses/NotFound"
        '500':
          $ref: '#/components/responses/InternalServerError'
  /devices/{deviceId}/unclaim:
    parameters:
      - $ref: "#/components/parameters/deviceId"
    put:
      tags:
        - Device Management
      summary: "Unclaims a device from exclusive use."
      operationId: unclaimDevice
      responses:
        '200':
          description: "Device successfully unclaimed"
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: "#/components/responses/NotFound"
        '500':
          $ref: '#/components/responses/InternalServerError'


components:
  parameters:
    deviceId:
      name: deviceId
      in: path
      description: "ID of the device that will be used."
      required: true
      schema:
        type: integer
        format: int64
        example: 42
  schemas:
    Device:
      description: "Claim information about a device"
      required:
        - deviceId
        - deviceName
        - deviceStatus
        - claimerCn
        - insurantId
        - deviceOs
      readOnly: true
      type: object
      properties:
        deviceId:
          type: integer
          format: int64
          description: "Identifier of the device"
          example: 4711
        deviceName:
          type: string
          description: "Name of the device"
          example: "awesome_device_01"
        deviceStatus:
          type: string
          enum: [ claimed, free ]
          description: "Status of the device"
        claimerCn:
          type: string
          description: "Common name of claimers client cert"
          example: "gematik GmbH"
        insurantId:
          $ref: "#/components/schemas/KvnrType"
        deviceOs:
          type: string
          description: "OS of the device e.g. android, ios, windows."
          example: android
    KvnrType:
      description: Type for insurantId.
      type: string
      pattern: '^[A-Z]{1}\d{9}$'
      example: Z123456789
    Problem:
      description: A problem detail object as defined in RFC 7807.
      type: object
      properties:
        type:
          type: string
          description: A URI reference that identifies the problem type
          examples:
            - https://example.com/probs/out-of-credit
        title:
          type: string
          description: A short, human-readable summary of the problem type
          examples:
            - You do not have enough credit.
        detail:
          type: string
          description: A human-readable explanation specific to this occurrence of the problem
          examples:
            - Your current balance is 30, but that costs 50.
        instance:
          type: string
          description: A URI reference that identifies the specific occurrence of the problem
          examples:
            - /account/12345/msgs/abc
        status:
          type: integer
          description: The HTTP status code
          examples:
            - 400
  responses:
    BadRequest:
      description: Bad Request
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/Problem'
          example:
            type: https://example.com/errors/bad-request
            title: Bad Request
            status: 400
            detail: The request is invalid or missing required parameters.
        application/problem+xml:
          schema:
            $ref: '#/components/schemas/Problem'
          example:
            type: https://example.com/errors/bad-request
            title: Bad Request
            status: 400
            detail: The request is invalid or missing required parameters.
    NotFound:
      description: Not Found
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/Problem'
          example:
            type: https://example.com/errors/not-found
            title: Not Found
            status: 404
            detail: The requested resource was not found.
    InternalServerError:
      description: Internal Server Error
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/Problem'
          example:
            type: https://example.com/errors/internal-server-error
            title: Internal Server Error
            status: 500
            detail: An unexpected error occurred.